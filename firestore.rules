rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection
    match /users/{userId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.data.role in ['business', 'rider'];
      
      allow update: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.data.role == resource.data.role;
      
      // Allow updating online status
      allow update: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isOnline', 'lastSeen']);
      
      // Allow updating wallet balance (only increases)
      allow update: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['walletBalance']) &&
                      request.resource.data.walletBalance >= resource.data.walletBalance;
      
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Deliveries collection
    match /deliveries/{deliveryId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'business' &&
                      request.resource.data.businessId == request.auth.uid;
      
      allow update: if request.auth != null &&
                      resource.data.businessId == request.auth.uid;
      
      allow update: if request.auth != null &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'rider' &&
                      (resource.data.status == 'pending' || resource.data.riderId == request.auth.uid);
      
      allow delete: if request.auth != null &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Chat messages subcollection
      match /messages/{messageId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && request.resource.data.senderId == request.auth.uid;
        allow update: if request.auth != null && resource.data.senderId == request.auth.uid;
        allow delete: if request.auth != null && resource.data.senderId == request.auth.uid;
      }
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if request.auth != null &&
                    (resource.data.userId == request.auth.uid || resource.data.riderId == request.auth.uid);
      
      allow create: if request.auth != null;
      
      allow update: if request.auth != null &&
                      (resource.data.userId == request.auth.uid || resource.data.riderId == request.auth.uid) &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
      
      allow delete: if request.auth != null &&
                      (resource.data.userId == request.auth.uid || resource.data.riderId == request.auth.uid);
    }
    
    // Transactions collection (M-Pesa payments)
    match /transactions/{transactionId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      allow create: if request.auth != null &&
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.type == 'topup' &&
                      request.resource.data.amount > 0;
      
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      
      allow delete: if false;
    }
    
    // Withdrawals collection
    match /withdrawals/{withdrawalId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      allow create: if request.auth != null &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'rider' &&
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.status == 'pending';
      
      allow update: if request.auth != null &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      allow delete: if false;
    }
    
    // Reviews collection
    match /reviews/{reviewId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null &&
                      request.resource.data.reviewerId == request.auth.uid;
      
      allow update: if request.auth != null &&
                      resource.data.reviewerId == request.auth.uid;
      
      allow delete: if request.auth != null &&
                      resource.data.reviewerId == request.auth.uid;
    }
    
    // Analytics collection
    match /analytics/{document=**} {
      allow read, write: if request.auth != null &&
                           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Settings collection
    match /settings/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
    // Allow users to read/write their own user document
    // IMPORTANT: For the admin panel to read all users, you must have a rule here
    // that allows users with role 'admin' to read the entire collection.
    // For example: allow list: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    match /users/{userId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;

      // Payments subcollection: only the user can read/write their own payments
      match /payments/{paymentId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // AssignedBike subcollection: user can read, only admin can write (role-based)
      match /assignedBike/{docId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }

      // Other subcollections (serviceRequests, issues, etc.)
      match /{subcollection}/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // NEW RULE FOR PAYROLL
    // This allows an admin to read/write all payroll documents,
    // and a user to read only their own.
    match /payroll/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Transactions subcollection: user can read, only admin can write
    match /users/{userId}/transactions/{docId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Applications collection: anyone can create, only admin can read, update, delete
    match /applications/{docId} {
      allow create: if true;
      allow read, update, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Subscribe collection: anyone can create, only admin can read/update/delete
    match /subscribe/{docId} {
      allow create: if true; // Anyone can subscribe
      allow read, update, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'; // Only admin can read/update/delete
    }

    // Contacting collection: anyone can create, only admin can read/update/delete
    match /contacting/{docId} {
      allow create: if true; // Anyone can send a message
      allow read, update, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'; // Only admin can read/update/delete
    }
  }
}